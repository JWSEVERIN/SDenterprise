const elc=id=>document.getElementById(id),tBodyC=document.querySelector('#customersTable tbody');let custPage=1,custTotalPages=1,custPerPage=10,custOrder=localStorage.getItem('order_customers')||'asc';const modalC=elc('modal'),formC=elc('customerForm'),modalTitleC=elc('modalTitle');function showModalC(edit=false,data={}){formC.id.value=data.id||'';formC.name.value=data.name||'';formC.company.value=data.company||'';formC.email.value=data.email||'';formC.phone.value=data.phone||'';formC.notes.value=data.notes||'';modalTitleC.textContent=edit?'Edit Customer':'New Customer';modalC.setAttribute('aria-hidden','false');modalC.style.display='block'}function hideModalC(){modalC.setAttribute('aria-hidden','true');modalC.style.display='none'}async function fetchCustomers(){const res=await fetch('/api/customers?page='+custPage+'&per_page='+custPerPage+'&order='+custOrder),body=await res.json(),list=body.data||body;custTotalPages=body.total_pages||1;const pageLabel=document.getElementById('pageLabel');pageLabel&&(pageLabel.textContent=`Page ${custPage} / ${custTotalPages}`);tBodyC.innerHTML='';for(const r of list){const tr=document.createElement('tr');tr.innerHTML=`<td>${r.id}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.company||'')}</td><td>${escapeHtml(r.email||'')}</td><td>${escapeHtml(r.phone||'')}</td><td>${escapeHtml(r.notes||'')}</td><td><button data-id="${r.id}" class="edit">Edit</button><button data-id="${r.id}" class="del">Delete</button></td>`;tBodyC.appendChild(tr)}}function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]))}document.addEventListener('click',async ev=>{if(ev.target.matches('#createBtn'))showModalC(false,{});else if(ev.target.matches('#cancelBtn'))hideModalC();else if(ev.target.matches('button.edit')){const id=ev.target.getAttribute('data-id'),res=await fetch('/api/customers/'+id);res.ok&&showModalC(true,await res.json())}else if(ev.target.matches('button.del')){if(!confirm('Delete customer?'))return;const id=ev.target.getAttribute('data-id'),res=await fetch('/api/customers/'+id,{method:'DELETE'});204===res.status?fetchCustomers():alert('Failed to delete')}});formC.addEventListener('submit',async e=>{e.preventDefault();const data={name:formC.name.value.trim(),company:formC.company.value.trim(),email:formC.email.value.trim(),phone:formC.phone.value.trim(),notes:formC.notes.value.trim()},id=formC.id.value;if(id){const res=await fetch('/api/customers/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});res.ok?(hideModalC(),fetchCustomers()):alert('Save failed')}else{const res=await fetch('/api/customers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});201===res.status?(hideModalC(),fetchCustomers()):alert('Create failed: '+(await res.json().catch(()=>({})).error||res.status))}});document.addEventListener('DOMContentLoaded',()=>{const orderBtn=document.getElementById('orderBtn');orderBtn&&(orderBtn.textContent='Order: '+('asc'===custOrder?'Asc':'Desc'),orderBtn.addEventListener('click',()=>{custOrder='asc'===custOrder?'desc':'asc';localStorage.setItem('order_customers',custOrder);orderBtn.textContent='Order: '+('asc'===custOrder?'Asc':'Desc');custPage=1;fetchCustomers()}));fetchCustomers();const prev=document.getElementById('prevBtn'),next=document.getElementById('nextBtn');prev&&prev.addEventListener('click',()=>{custPage>1&&(custPage--,fetchCustomers())});next&&next.addEventListener('click',()=>{custPage<custTotalPages&&(custPage++,fetchCustomers())})});
